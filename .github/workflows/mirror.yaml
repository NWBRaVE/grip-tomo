---
name: Mirror to NWBRaVE
'on':
  push:
    branches: ["**"]
    tags: ["**"]
  delete:
  workflow_dispatch:

concurrency:
  group: mirror
  cancel-in-progress: true

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH for pushing to NWBRaVE
        env:
          MIRROR_SSH_KEY: ${{ secrets.MIRROR_SSH_KEY }}
        run: |
          set -euo pipefail
          if [ -z "$MIRROR_SSH_KEY" ]; then
            echo "Error: MIRROR_SSH_KEY secret is not set"
            exit 1
          fi
          mkdir -p ~/.ssh
          printf '%s\n' "$MIRROR_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -t ed25519 github.com >> ~/.ssh/known_hosts

      - name: Mirror branches and tags
        run: |
          set -euo pipefail

          echo "Initializing bare repository for mirroring..."
          git init --bare repo.git
          cd repo.git

          echo "Configuring git..."
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          echo "Adding upstream remote..."
          git remote add upstream \
            https://github.com/EMSL-Computing/grip-tomo.git

          echo "Fetching all refs from upstream..."
          git fetch --prune upstream \
            '+refs/heads/*:refs/heads/*' '+refs/tags/*:refs/tags/*'

          echo "Adding destination remote..."
          git remote add dest git@github.com:NWBRaVE/grip-tomo.git

          echo "Pushing mirror to destination..."
          # Push all branches and tags, but exclude internal GitHub refs
          # like refs/pull/* to avoid "deny updating a hidden ref" errors
          git push dest 'refs/heads/*:refs/heads/*' \
            'refs/tags/*:refs/tags/*' --prune

          echo "Mirror completed successfully!"

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519
