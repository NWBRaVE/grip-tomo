name: Mirror to NWBRaVE
on:
  push:
    branches: ["**"]
    tags: ["**"]
  delete:
  workflow_dispatch:

concurrency:
  group: mirror
  cancel-in-progress: true

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH for pushing to NWBRaVE
        env:
          MIRROR_SSH_KEY: ${{ secrets.MIRROR_SSH_KEY }}
        run: |
          set -euo pipefail
          if [ -z "$MIRROR_SSH_KEY" ]; then echo "Error: MIRROR_SSH_KEY secret is not set"; exit 1; fi
          mkdir -p ~/.ssh
          (umask 077; printf '%s\n' "$MIRROR_SSH_KEY" > ~/.ssh/id_ed25519)
          ssh-keyscan -t ed25519,ecdsa-sha2-nistp256,rsa github.com >> ~/.ssh/known_hosts

      - name: Mirror branches and tags
        run: |
          set -euo pipefail
          git clone --mirror https://github.com/EMSL-Computing/grip-tomo.git repo.git
          cd repo.git
          git remote add dest git@github.com:NWBRaVE/grip-tomo.git
          # Push branches and tags, pruning deletions; exclude refs/pull/*
          git push dest 'refs/heads/*:refs/heads/*' 'refs/tags/*:refs/tags/*' --prune --force
